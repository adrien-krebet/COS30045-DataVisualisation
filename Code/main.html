<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JavaScript Choropleth Map</title>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-map.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/geodata/custom/world/world.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-data-adapter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    .legend {
      font-family: Arial, sans-serif;
      font-size: 12px;
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ccc;
      position: absolute;
      bottom: 20px;
      right: 10px;
      width: 150px;
    }
    .legend .color-box {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 5px;
    }
    .year-label {
      font-family: Arial, sans-serif;
      font-size: 16px;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="initial">
      <a class="link" href="line_chart.html"><span>Line</span></a>
      <a class="link" href="dumbbell_chart.html"><span>Dumbbell</span></a>
      <a class="link active" href="main.html"><span>Map</span></a>
    </div>
  </div>
  <!--   <div class="year-label" id="year-label">Year: 2011</div>   -->
  <div id="container" style="width: 100%; height: 550px;"></div>
  <div id="timeline" style="width: 100%; height: 50px; margin-top: 30px;"></div>
  <div class="legend">
    <div><span class="color-box" style="background: rgba(76, 175, 80, 1);"></span>Above Average</div>
    <div><span class="color-box" style="background: rgba(255, 152, 0, 1);"></span>Average</div>
    <div><span class="color-box" style="background: rgba(244, 67, 54, 1);"></span>Below Average</div>
  </div>

  <script>
    anychart.onDocumentReady(function () {
      d3.csv("total_population.csv").then(function(data) {
        let parsedData = {};
        data.forEach(d => {
          let country = d.Country;
          parsedData[country] = {};
          for (let year = 2010; year <= 2019; year++) {
            parsedData[country][year] = +d[year];
          }
        });

        let averages = parsedData["Average"];

        let map = anychart.map();
        map.geoData("anychart.maps.world");
        map.title("Life Expectancy in Different Countries Compared to the OECD Average (hover mouse for exact values)");

        const w = 800;
        const padding = 20;
        let selectedYear = 2011;
        const averageRange = 2; 

        function updateChart(year) {
          let yearData = Object.keys(parsedData).map(country => {
            if (country === "Average") return null;
            let countryValue = parsedData[country][year];
            let averageValue = averages[year];
            let color = "#FFFFFF"; 
            if (countryValue !== undefined) {
              if (countryValue > averageValue + averageRange) {
                color = `rgba(76, 175, 80, ${(countryValue - averageValue) / (100 - averageValue) + 0.5})`; 
              } else if (countryValue < averageValue - averageRange) {
                color = `rgba(244, 67, 54, ${(averageValue - countryValue) / averageValue + 0.5})`; 
              } else {
                color = "#FF9800";
              }
            }
            return {
              id: getCountryId(country),
              value: countryValue,
              fill: color
            };
          }).filter(d => d !== null);

          let dataSet = anychart.data.set(yearData);
          let series = map.choropleth(dataSet);
          series.geoIdField('id');

          series.colorScale(anychart.scales.ordinalColor([
            { less: averages[year] - averageRange, color: 'rgba(244, 67, 54, 1)' },
            { from: averages[year] - averageRange, to: averages[year] + averageRange, color: 'rgba(255, 152, 0, 1)' },
            { greater: averages[year] + averageRange, color: 'rgba(76, 175, 80, 1)' }
          ]));

          series.hovered().fill("#f48fb1");
          series.selected().fill("#c2185b");

          series.tooltip().format(function() {
            let country = this.name;
            let value = parsedData[country][selectedYear];
            return `Country: ${country}\nYear: ${selectedYear}\nValue: ${value}`;
          });


          map.container("container");
          map.draw();

          // document.getElementById("year-label").innerText = "Year: " + year;
        }

        function getCountryId(countryName) {
          let countryIdMap = {
            "Australia": "AU", "Austria": "AT", "Belgium": "BE", "Canada": "CA", "Chile": "CL",
            "Colombia": "CO", "Costa Rica": "CR", "Czechia": "CZ", "Denmark": "DK", "Estonia": "EE",
            "Finland": "FI", "France": "FR", "Germany": "DE", "Greece": "GR", "Hungary": "HU",
            "Iceland": "IS", "Ireland": "IE", "Israel": "IL", "Italy": "IT", "Japan": "JP",
            "Korea": "KR", "Latvia": "LV", "Lithuania": "LT", "Luxembourg": "LU", "Mexico": "MX",
            "Netherlands": "NL", "New Zealand": "NZ", "Norway": "NO", "Poland": "PL", "Portugal": "PT",
            "Slovak Republic": "SK", "Slovenia": "SI", "Spain": "ES", "Sweden": "SE", "Switzerland": "CH",
            "TÃ¼rkiye": "TR", "United Kingdom": "GB", "United States": "US", "Argentina": "AR",
            "Brazil": "BR", "Bulgaria": "BG", "China": "CN", "Croatia": "HR", "India": "IN",
            "Indonesia": "ID", "Peru": "PE", "Romania": "RO", "Russia": "RU", "South Africa": "ZA"
          };
          return countryIdMap[countryName] || countryName;
        }

        function drawTimeline() {
          const w = 800; // Original width of the timeline
          const padding = 20; // General padding
          const leftPadding = 400; // Added left padding
          const rightPadding = 400; // Added right padding
        
          // Create the SVG with adjusted width
          var timelineSvg = d3.select("#timeline")
            .append("svg")
            .attr("width", w + leftPadding + rightPadding)
            .attr("height", 50)
            .style("margin", "0 auto");
        
          // Define the scale with adjusted range for padding
          var yearScale = d3.scaleLinear()
            .domain([2010, 2019])
            .range([leftPadding, w + leftPadding - padding])
            .nice();
        
          // Define the year ticks
          var yearTicks = d3.range(2010, 2020);
        
          // Append the axis
          timelineSvg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0, 20)")
            .call(d3.axisBottom(yearScale).tickValues(yearTicks).tickFormat(d3.format("d")));
        
          // Append the slider handle
          var sliderHandle = timelineSvg.append("circle")
            .attr("class", "slider-handle")
            .attr("cx", yearScale(selectedYear))
            .attr("cy", 20)
            .attr("r", 8)
            .style("fill", "black");
        
          // Define the drag behavior
          var dragBehavior = d3.drag()
            .on("start drag", function(event) {
              var x = Math.max(leftPadding, Math.min(w + leftPadding - padding, d3.pointer(event)[0]));
              var closestYear = Math.round(yearScale.invert(x));
              closestYear = Math.min(Math.max(closestYear, 2010), 2019); // Ensure within bounds
              sliderHandle.attr("cx", yearScale(closestYear));
              selectedYear = closestYear;
              updateChart(selectedYear);
            });
        
          // Add a transparent rectangle to capture drag events
          timelineSvg.append("rect")
            .attr("x", leftPadding)
            .attr("width", w)
            .attr("height", 50)
            .style("fill", "none")
            .style("pointer-events", "all")
            .call(dragBehavior);
        
          // Define the years array
          var years = [2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019];
        
          // Append the navigation links (if applicable)
          var navLinks = d3.select("#navbar")
            .selectAll(".link")
            .data(years)
            .enter()
            .append("div")
            .attr("class", "link")
            .classed("active", function(d) { return d === selectedYear; })
            .text(function(d) { return d; })
            .on("click", function(d) {
              selectedYear = d;
              updateChart(selectedYear);
              d3.select("#navbar").selectAll(".link").classed("active", false);
              d3.select(this).classed("active", true);
            });
        }

        updateChart(selectedYear);
        drawTimeline();
      });
    });
  </script>
</body>
</html>
