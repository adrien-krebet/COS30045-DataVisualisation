<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JavaScript Choropleth Map</title>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-map.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/geodata/custom/world/world.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-data-adapter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="navbar">
  <div class="initial">
    <a class="link" href="line_chart.html"><span>Line</span></a>            
    <a class="link" href="dumbbell_chart.html"><span>Dumbbell</span></a>
    <a class="link active" href="main.html"><span>Map</span></a>
  </div>
</div>

<div id="container" style="width: 100%; height: 550px;"></div>
<div id="timeline" style="width: 100%; height: 50px; margin-top: 30px;"></div>

<script>
  anychart.onDocumentReady(function () {
    d3.csv("total_population.csv").then(function(data) {
      // Parse the CSV data
      let parsedData = data.map(d => {
        let country = d.Country;
        let values = {};
        for (let year = 2010; year <= 2019; year++) {
          values[year] = +d[year];
        }
        return { country: country, values: values };
      });

      // Extract the average values
      let averages = parsedData.find(d => d.country === "Average").values;

      // Initialize the map
      let map = anychart.map();
      map.geoData("anychart.maps.world");
      map.title("Life Expectancy in Different Countries Compared to the OECD Average");

      const w = 800;
      const padding = 20;
      let selectedYear = 2011;

      function updateChart(year) {
        let yearData = parsedData.map(d => {
          let countryValue = d.values[year];
          let averageValue = averages[year];
          let color = "#FFFFFF"; // default color for no data
          if (countryValue !== undefined) {
            if (countryValue > averageValue) {
              color = "#4CAF50"; // green
            } else if (countryValue < averageValue) {
              color = "#F44336"; // red
            } else {
              color = "#FF9800"; // orange
            }
          }
          return {
            id: d3.geoCountryNames[d.country], // Ensure this matches the geodata ID
            value: countryValue,
            fill: color
          };
        });

        // Create a dataset with a new structure to include color
        let dataSet = anychart.data.set(yearData);
        let series = map.choropleth(dataSet);
        series.colorScale(null);
        series.colorScale(anychart.scales.ordinalColor([
          { less: 0, color: '#F44336' }, // red
          { from: 0, to: 0, color: '#FF9800' }, // orange
          { greater: 0, color: '#4CAF50' }, // green
        ]));
        series.colorScale().ticks(false);
        series.colorScale().enabled(false);

        map.container("container");
        map.draw();
      }

      function drawTimeline() {
        var timelineSvg = d3.select("#timeline")
          .append("svg")
          .attr("width", w)
          .attr("height", 50);

        var yearScale = d3.scaleLinear()
          .domain([2011, 2020])
          .range([padding, w - padding]);

        timelineSvg.append("g")
          .attr("class", "axis")
          .attr("transform", "translate(0, 20)")
          .call(d3.axisBottom(yearScale).ticks(10).tickFormat(d3.format("d")));

        var sliderHandle = timelineSvg.append("circle")
          .attr("class", "slider-handle")
          .attr("cx", yearScale(selectedYear))
          .attr("cy", 20)
          .attr("r", 8)
          .style("fill", "black");

        sliderHandle.call(d3.drag()
          .on("drag", function(event) {
            var x = Math.max(padding, Math.min(w - padding, d3.pointer(event)[0]));
            sliderHandle.attr("cx", x);
            selectedYear = Math.round(yearScale.invert(x));
            updateChart(selectedYear);
          }));
      }

      updateChart(selectedYear);
      drawTimeline();
    });
  });
</script>
</body>
</html>
