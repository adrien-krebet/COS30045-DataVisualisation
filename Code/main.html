<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JavaScript Choropleth Map</title>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-map.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/geodata/custom/world/world.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-data-adapter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="navbar">
    <div class="initial">
      <a class="link" href="line_chart.html"><span>Line</span></a>            
      <a class="link" href="dumbbell_chart.html"><span>Dumbbell</span></a>
      <a class="link active" href="main.html"><span>Map</span></a>
    </div>
  </div>

  <div id="container" style="width: 100%; height: 550px;"></div>
  <div id="timeline" style="width: 100%; height: 50px; margin-top: 30px;"></div>

  <script>
    anychart.onDocumentReady(function () {
      d3.csv("total_population.csv").then(function(data) {
        // Parse the CSV data
        let parsedData = {};
        data.forEach(d => {
          let country = d.Country;
          parsedData[country] = {};
          for (let year = 2010; year <= 2019; year++) {
            parsedData[country][year] = +d[year];
          }
        });

        // Extract the average values
        let averages = parsedData["Average"];

        // Initialize the map
        let map = anychart.map();
        map.geoData("anychart.maps.world");
        map.title("Life Expectancy in Different Countries Compared to the OECD Average");

        const w = 800;
        const padding = 20;
        let selectedYear = 2011;
        const averageRange = 0.1; // Define a range for average comparison

        function updateChart(year) {
          let yearData = Object.keys(parsedData).map(country => {
            if (country === "Average") return null;
            let countryValue = parsedData[country][year];
            let averageValue = averages[year];
            let color = "#FFFFFF"; // default color for no data
            if (countryValue !== undefined) {
              if (countryValue > averageValue + averageRange) {
                color = `rgba(76, 175, 80, ${(countryValue - averageValue) / (100 - averageValue)})`; // gradient green
              } else if (countryValue < averageValue - averageRange) {
                color = `rgba(244, 67, 54, ${(averageValue - countryValue) / averageValue})`; // gradient red
              } else {
                color = "#FF9800"; // orange
              }
            }
            return {
              id: getCountryId(country),
              value: countryValue,
              fill: color
            };
          }).filter(d => d !== null);

          // Create a dataset with the new structure to include color
          let dataSet = anychart.data.set(yearData);
          let series = map.choropleth(dataSet);
          series.geoIdField('id');
          series.colorScale(null); // Disable default color scale
          series.hovered().fill("#f48fb1"); // Add hover state color
          series.selected().fill("#c2185b"); // Add selected state color

          map.container("container");
          map.draw();
        }

        function getCountryId(countryName) {
          // Country mappings
          let countryIdMap = {
            "Australia": "AU", "Austria": "AT", "Belgium": "BE", "Canada": "CA", "Chile": "CL",
            "Colombia": "CO", "Costa Rica": "CR", "Czechia": "CZ", "Denmark": "DK", "Estonia": "EE",
            "Finland": "FI", "France": "FR", "Germany": "DE", "Greece": "GR", "Hungary": "HU",
            "Iceland": "IS", "Ireland": "IE", "Israel": "IL", "Italy": "IT", "Japan": "JP",
            "Korea": "KR", "Latvia": "LV", "Lithuania": "LT", "Luxembourg": "LU", "Mexico": "MX",
            "Netherlands": "NL", "New Zealand": "NZ", "Norway": "NO", "Poland": "PL", "Portugal": "PT",
            "Slovak Republic": "SK", "Slovenia": "SI", "Spain": "ES", "Sweden": "SE", "Switzerland": "CH",
            "TÃ¼rkiye": "TR", "United Kingdom": "GB", "United States": "US", "Argentina": "AR",
            "Brazil": "BR", "Bulgaria": "BG", "China": "CN", "Croatia": "HR", "India": "IN",
            "Indonesia": "ID", "Peru": "PE", "Romania": "RO", "Russia": "RU", "South Africa": "ZA"
          };
          return countryIdMap[countryName] || countryName;
        }

        function drawTimeline() {
          var timelineSvg = d3.select("#timeline")
            .append("svg")
            .attr("width", w)
            .attr("height", 50);

          var yearScale = d3.scaleLinear()
            .domain([2010, 2019])
            .range([padding, w - padding]);

          timelineSvg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0, 20)")
            .call(d3.axisBottom(yearScale).ticks(10).tickFormat(d3.format("d")));

          var sliderHandle = timelineSvg.append("circle")
            .attr("class", "slider-handle")
            .attr("cx", yearScale(selectedYear))
            .attr("cy", 20)
            .attr("r", 8)
            .style("fill", "black");

          sliderHandle.call(d3.drag()
            .on("drag", function(event) {
              var x = Math.max(padding, Math.min(w - padding, d3.pointer(event)[0]));
              sliderHandle.attr("cx", x);
              selectedYear = Math.round(yearScale.invert(x));
              updateChart(selectedYear);
            }));
        }

        updateChart(selectedYear);
        drawTimeline();
      });
    });
  </script>
</body>
</html>
