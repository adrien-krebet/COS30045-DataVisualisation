<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JavaScript Choropleth Map</title>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-map.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/geodata/custom/world/world.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.1/js/anychart-data-adapter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="navbar">
    <div class="initial">
      <a class="link" href="line_chart.html"><span>Line</span></a>            
      <a class="link" href="dumbbell_chart.html"><span>Dumbbell</span></a>
      <a class="link active" href="main.html"><span>Map</span></a>
    </div>
  </div>

  <div id="container" style="width: 100%; height: 550px;"></div>
  <div id="timeline" style="width: 100%; height: 50px; margin-top: 30px;"></div>

  <script>
    anychart.onDocumentReady(function () {
      let map = anychart.map();
      map.geoData("anychart.maps.world");
      map.title("Life Expectancy in Different Countries Compared to the OECD Average");

      const w = 800;
      const padding = 20;
      let selectedYear = 2011;
      let parsedData;

      function updateChart(year) {
        // Clear existing series
        map.removeAllSeries();

        // Load data from CSV
        d3.csv("total_population.csv").then(function(data) {
          parsedData = {};
          data.forEach(d => {
            let country = d.Country;
            parsedData[country] = {};
            for (let year = 2010; year <= 2019; year++) {
              parsedData[country][year] = +d[year];
            }
          });

          let yearData = Object.keys(parsedData).map(country => {
            if (country === "Average") return null;
            let countryValue = parsedData[country][year];
            let averageValue = calculateAverage(year);
            let color = "#FFFFFF";
            if (countryValue !== undefined) {
              if (countryValue > averageValue) {
                color = "#4CAF50"; // green
              } else if (countryValue < averageValue) {
                color = "#F44336"; // red
              } else {
                color = "#FF9800"; // orange
              }
            }
            return {
              id: getCountryId(country),
              value: countryValue,
              fill: color
            };
          }).filter(d => d !== null);

          let dataSet = anychart.data.set(yearData);
          let series = map.choropleth(dataSet);
          series.geoIdField('id');
          series.colorScale(null);
          series.hovered().fill("#f48fb1");
          series.selected().fill("#c2185b");
        });
      }

      function calculateAverage(year) {
        // Calculate the average life expectancy for the selected year
        let total = 0;
        let count = 0;
        Object.keys(parsedData).forEach(country => {
          if (country !== "Average" && parsedData[country][year] !== undefined) {
            total += parsedData[country][year];
            count++;
          }
        });
        return total / count;
      }

      function getCountryId(countryName) {
        // Map country name to its corresponding ID
        let countryIdMap = {
          "Australia": "AU",
          "Austria": "AT",
          "Belgium": "BE",
          "Canada": "CA",
          "Chile": "CL",
          "Colombia": "CO",
          "Costa Rica": "CR",
          "Czechia": "CZ",
          "Denmark": "DK",
          "Estonia": "EE",
          "Finland": "FI",
          "France": "FR",
          "Germany": "DE",
          "Greece": "GR",
          "Hungary": "HU",
          "Iceland": "IS",
          "Ireland": "IE",
          "Israel": "IL",
          "Italy": "IT",
          "Japan": "JP",
          "Korea": "KR",
          "Latvia": "LV",
          "Lithuania": "LT",
          "Luxembourg": "LU",
          "Mexico": "MX",
          "Netherlands": "NL",
          "New Zealand": "NZ",
          "Norway": "NO",
          "Poland": "PL",
          "Portugal": "PT",
          "Slovak Republic": "SK",
          "Slovenia": "SI",
          "Spain": "ES",
          "Sweden": "SE",
          "Switzerland": "CH",
          "TÃ¼rkiye": "TR",
          "United Kingdom": "GB",
          "United States": "US",
          "Argentina": "AR",
          "Brazil": "BR",
          "Bulgaria": "BG",
          "China": "CN",
          "Croatia": "HR",
          "India": "IN",
          "Indonesia": "ID",
          "Peru": "PE",
          "Romania": "RO",
          "Russia": "RU",
          "South Africa": "ZA"
          // Add more mappings as needed
        };
        return countryIdMap[countryName] || countryName;
      }

      function drawTimeline() {
        // Draw timeline slider
        var timelineSvg = d3.select("#timeline")
          .append("svg")
          .attr("width", w)
          .attr("height", 50);

        var yearScale = d3.scaleLinear()
          .domain([2011, 2019])
          .range([padding, w -
