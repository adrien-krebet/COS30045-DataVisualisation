<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="style.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .line {
        fill: none;
        stroke-width: 2;
        stroke: black;
    }

    .hovered {
        stroke: red;
        stroke-width: 2px;
    }

    .tooltip {
        position: absolute;
        text-align: center;
        width: auto;
        height: auto;
        padding: 8px;
        font: 12px sans-serif;
        background: lightgrey;
        border: 0px;
        border-radius: 4px;
        pointer-events: none;
        opacity: 0;
    }

    .circleMale {
        fill: blue;
    }

    .circleFemale {
        fill: pink;
    }

    .circleAverage {
        fill: gray;
    }

    .slider-handle {
        fill: red;
        cursor: pointer;
    }

    .axis path,
    .axis line {
        fill: none;
        shape-rendering: crispEdges;
    }

    #container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #dumbbell {
        width: 100%;
    }

    #timeline {
        width: 100%;
        margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="initial">
      <a class="link" href="line_chart.html"><span>Line</span></a>
      <a class="link active" href="dumbbell_chart.html"><span>Dumbbell</span></a>
      <a class="link" href="main.html"><span>Map</span></a>
    </div>
  </div>

  <h2>The Difference in Life Expectancy Between Men and Women in Different Countries</h2>
  <p>Hover your mouse over the dots to see the exact values</p>
  
  <div id="container">
    <div id="dumbbell"></div>
    <div id="timeline"></div>
  </div>

  <div class="tooltip" id="tooltip"></div>
  
  <script>
    var w = 1000;
    var h = 600; 
    var padding = 50;
    var bottomPadding = 90; 
    var selectedYear = 2011; // Initially selected year

    var yMin = 50; 
    var yMax = 90;

    d3.csv("male_atbirth.csv").then(function(maleData) {
      d3.csv("female_atbirth.csv").then(function(femaleData) {
        var dataset = [];

        maleData.forEach(function(male) {
          var female = femaleData.find(f => f.Country === male.Country);
          if (female) {
            var data = { "Country": male.Country };
            for (var year = 2011; year <= 2019; year++) {
              data[year] = {
                "Male": +male[year],
                "Female": +female[year]
              };
            }
            dataset.push(data);
          }
        });

        dumbbellChart(dataset);
      });
    });

    function dumbbellChart(dataset) {
      var svg = d3.select("#dumbbell")
        .append("svg")
        .attr("width", w)
        .attr("height", h);

      var xScale = d3.scaleBand()
        .range([padding, w - padding])
        .padding(0.1);

      var yScale = d3.scaleLinear()
        .domain([yMin, yMax])
        .range([h - padding - bottomPadding, padding]);

      var xAxis = d3.axisBottom(xScale);
      var yAxis = d3.axisLeft(yScale);

      var xAxisGroup = svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (h - padding - bottomPadding) + ")");

      var yAxisGroup = svg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + padding + ",0)");

      function updateChart(selectedYear) {
        var data = dataset.map(function(d) {
          return [d.Country, d[selectedYear].Male, d[selectedYear].Female];
        });

        xScale.domain(data.map(function(d) { return d[0]; }));

        xAxisGroup.call(xAxis)
          .selectAll("text")
          .attr("transform", "rotate(-45)")
          .attr("dx", "-.8em")
          .attr("dy", ".15em")
          .style("text-anchor", "end");

        yAxisGroup.call(yAxis);

        var lines = svg.selectAll(".line")
          .data(data);

        lines.enter()
          .append("line")
          .attr("class", "line")
          .attr("x1", function(d) { return xScale(d[0]) + xScale.bandwidth() / 2; })
          .attr("x2", function(d) { return xScale(d[0]) + xScale.bandwidth() / 2; })
          .attr("y1", function(d) { return yScale(d[1]); })
          .attr("y2", function(d) { return yScale(d[1]); }) 
          .merge(lines)
          .transition()
          .duration(500)
          .attr("x1", function(d) { return xScale(d[0]) + xScale.bandwidth() / 2; })
          .attr("x2", function(d) { return xScale(d[0]) + xScale.bandwidth() / 2; })
          .attr("y1", function(d) { return yScale(d[1]); })
          .attr("y2", function(d) { return yScale(d[2]); }); 
        
        lines.exit().remove();

        var circlesMale = svg.selectAll(".circleMale")
          .data(data);

        circlesMale.enter()
        .append("circle")
        .attr("class", "circleMale")
        .merge(circlesMale)
        .attr("cx", function(d) { return xScale(d[0]) + xScale.bandwidth() / 2; })
        .attr("cy", function(d) { return yScale(d[1]); })
        .attr("r", 5)
        .on("mouseover", function(event, d) {
            d3.select("#tooltip")
                .style("opacity", 1)
                .html("Male: " + d[1]);
        })
        .on("mousemove", function(event) {
            d3.select("#tooltip")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 25) + "px");
        })
        .on("mouseout", function() {
            d3.select("#tooltip")
                .style("opacity", 0);
        });
        
        circlesMale.exit().remove();

        var circlesFemale = svg.selectAll(".circleFemale")
          .data(data);

        circlesFemale.enter()
        .append("circle")
        .attr("class", "circleFemale")
        .merge(circlesFemale)
        .attr("cx", function(d) { return xScale(d[0]) + xScale.bandwidth() / 2; })
        .attr("cy", function(d) { return yScale(d[2]); })
        .attr("r", 5)
        .on("mouseover", function(event, d) {
            d3.select("#tooltip")
                .style("opacity", 1)
                .html("Female: " + d[2]);
        })
        .on("mousemove", function(event) {
            d3.select("#tooltip")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 25) + "px");
        })
        .on("mouseout", function() {
            d3.select("#tooltip")
                .style("opacity", 0);
        });

        circlesFemale.exit().remove();

        var circlesAverage = svg.selectAll(".circleAverage")
          .data(data);

        circlesAverage.enter()
        .append("circle")
        .attr("class", "circleAverage")
        .merge(circlesAverage)
        .attr("cx", function(d) { return xScale(d[0]) + xScale.bandwidth() / 2; })
        .attr("cy", function(d) { return yScale((d[1] + d[2]) / 2); })
        .attr("r", 5)
        .on("mouseover", function(event, d) {
            d3.select("#tooltip")
                .style("opacity", 1)
                .html("Average: " + ((d[1] + d[2]) / 2).toFixed(2));
        })
        .on("mousemove", function(event) {
            d3.select("#tooltip")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 25) + "px");
        })
        .on("mouseout", function() {
            d3.select("#tooltip")
                .style("opacity", 0);
        });

        circlesAverage.exit().remove();
      }

      drawTimeline();

      function drawTimeline() {
        const timelineSvg = d3.select("#timeline")
          .append("svg")
          .attr("width", w)
          .attr("height", 50);

        const yearScale = d3.scaleLinear()
          .domain([2011, 2019])
          .range([padding, w - padding]);

        timelineSvg.append("g")
          .attr("class", "axis")
          .attr("transform", "translate(0, 20)")
          .call(d3.axisBottom(yearScale).ticks(10).tickFormat(d3.format("d")));

        const sliderHandle = timelineSvg.append("circle")
          .attr("class", "slider-handle")
          .attr("cx", yearScale(selectedYear))
          .attr("cy", 20)
          .attr("r", 8)
          .call(d3.drag().on("drag", function(event) {
            const newYear = Math.round(yearScale.invert(event.x));
            if (newYear >= 2011 && newYear <= 2019) {
              sliderHandle.attr("cx", yearScale(newYear));
              selectedYear = newYear;
              updateChart(selectedYear);
            }
          }));
      }

      updateChart(selectedYear);
    }
  </script>
</body>
</html>

