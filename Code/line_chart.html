<!DOCTYPE html>
<html lang="en">
<head>
    <title>Task 2.4 D3 Data Import</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        h1 {
            font-family: sans-serif;
        }

        .line {
            fill: none;
            stroke-width: 2;
            stroke: black;
        }

        .legend rect {
            cursor: pointer;
        }

        .circle {
            stroke: black;
        }

        .circle.AUS {
            fill: green;
        }

        .circle.CAN {
            fill: red;
        }

        .circle.USA {
            fill: yellow;
        }

        .circle.GBR {
            fill: blue;
        }

        .circle.CHN {
            fill: purple;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: lightgrey;
            border: 0px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="initial">
            <a class="link active" href="line_chart.html"><span>Line</span></a>
            <a class="link" href="dumbbell_chart.html"><span>Dumbbell</span></a>
            <a class="link" href="main.html"><span>Map</span></a>
        </div>
    </div>
    <div id="container">
        <div id="chart"></div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        function init() {
            var w = 900; 
            var h = 400;
            var padding = 50;

            var dataset = [];

            d3.csv("life_expectancy.csv", function(d) {
                return {
                    country: d.COU,
                    year: +d.YEA,
                    value: +d.Value,
                    variable: d.VAR
                };
            }).then(function(data) {
                dataset = data.filter(d => (d.variable === "EVIETOTA") && (d.year >= 2011) && (d.year <= 2019) && ((d.country === "AUS") || (d.country === "CAN") || (d.country === "USA") || (d.country === "GBR") || (d.country === "CHN")));
                lineChart(dataset);
                console.table(dataset, ["country", "year", "value"]);
            });

            function lineChart(dataset) {
                var xScale = d3.scaleTime()
                    .domain([new Date(2011, 0, 1), new Date(2019, 11, 31)])
                    .range([padding + 20, w - padding]);

                var yScale = d3.scaleLinear()
                    .domain([d3.min(dataset, d => d.value) - 1, d3.max(dataset, d => d.value) + 1])
                    .range([h - padding, padding]);

                var line = d3.line()
                    .x(d => xScale(new Date(d.year, 0, 1)))
                    .y(d => yScale(d.value));

                var svg = d3.select("#chart")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

                var colors = {
                    "AUS": "green",
                    "CAN": "red",
                    "USA": "yellow", 
                    "GBR": "blue",  
                    "CHN": "purple"  
                };

                var ausData = dataset.filter(d => d.country === "AUS");
                var canData = dataset.filter(d => d.country === "CAN");
                var usaData = dataset.filter(d => d.country === "USA");
                var gbrData = dataset.filter(d => d.country === "GBR");
                var chnData = dataset.filter(d => d.country === "CHN");

                function drawLine(data, country) {
                    svg.append("path")
                        .datum(data)
                        .attr("class", `line ${country}`)
                        .attr("d", line);

                    svg.selectAll(`circle.${country}`)
                        .data(data)
                        .enter()
                        .append("circle")
                        .attr("class", `circle ${country}`)
                        .attr("cx", d => xScale(new Date(d.year, 0, 1)))
                        .attr("cy", d => yScale(d.value))
                        .attr("r", 5)
                        .on("mouseover", function(event, d) {
                            d3.select("#tooltip")
                                .style("opacity", 1)
                                .html(`Country: ${d.country}<br>Year: ${d.year}<br>Value: ${d.value}`);
                        })
                        .on("mousemove", function(event) {
                            d3.select("#tooltip")
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 25) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select("#tooltip")
                                .style("opacity", 0);
                        });
                }

                drawLine(ausData, "AUS");
                drawLine(canData, "CAN");
                drawLine(usaData, "USA");
                drawLine(gbrData, "GBR");
                drawLine(chnData, "CHN");

                var xAxis = d3.axisBottom(xScale).ticks(9);
                var yAxis = d3.axisLeft(yScale).ticks(10);

                svg.append("g")
                    .attr("transform", "translate(0, " + (h - padding) + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("transform", "translate(" + (padding + 20) + ", 0)")
                    .call(yAxis);

                var legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${w - padding - 180}, ${padding})`); //adjust number to move the key/legend

                var countries = ["AUS", "CAN", "USA", "GBR", "CHN"];
                countries.forEach((country, i) => {
                    var legendRow = legend.append("g")
                        .attr("transform", `translate(0, ${i * 20})`);

                    legendRow.append("rect")
                        .attr("width", 10)
                        .attr("height", 10)
                        .attr("fill", colors[country])
                        .attr("stroke", "black")
                        .attr("stroke-width", 2);

                    legendRow.append("text")
                        .attr("x", 20)
                        .attr("y", 10)
                        .attr("text-anchor", "start")
                        .style("text-transform", "capitalize")
                        .text(country === "AUS" ? "Australia" : country === "CAN" ? "Canada" : country === "USA" ? "United States" : country === "GBR" ? "United Kingdom" : "China (People's Republic of)");

                    legendRow.on("click", function() {
                        var isActive = d3.selectAll(`.${country}`).style("display") === "none";
                        d3.selectAll(`.${country}`).style("display", isActive ? "block" : "none");
                    });
                });
            }
        }

        window.onload = init;
    </script>
</body>
</html>
